<!-- Note : Requires ANT 1.9.8+ -->
<project xmlns:if="ant:if" xmlns:unless="ant:unless">
  <target name="javadoc" description="generate java documentation">
    <javadoc sourcepath="src" sourcefiles="src/*.java" destdir="javadoc">
      <classpath>
        <fileset dir="${home}/jars" includes="*.jar"/>
      </classpath>
    </javadoc>
  </target>

  <target name="depnatives">
    <copy todir=".">
      <fileset dir="${home}/native" includes="*.dll"/>
      <fileset dir="${home}/native" includes="*.so"/>
      <fileset dir="${home}/native" includes="*.dylib"/>
    </copy>
  </target>

  <!-- need this to download ONLY if file doesn't exist -->
  <macrodef name="download">
    <attribute name="url"/>
    <attribute name="dest"/>
    <sequential>
      <get src="@{url}" dest="@{dest}" usetimestamp="true"/>
    </sequential>
  </macrodef>

  <!-- Windows targets -->

  <!--these should be set before importing this file to override default behavior-->
  <property name="ico" value="${app}"/>
  <property name="ico2" value="${app2}"/>
  <property name="ico3" value="${app3}"/>
  <property name="ico4" value="${app4}"/>
  <property name="ico5" value="${app5}"/>
  <property name="msi" value="${app}"/>
  <property name="candle_extra" value=""/>
  <property name="light_extra" value=""/>
  <property name="app2" value=""/>
  <property name="app3" value=""/>
  <property name="app4" value=""/>
  <property name="app5" value=""/>
  <property name="apptype" value=""/>
  <property name="apptype2" value=""/>
  <property name="apptype3" value=""/>
  <property name="apptype4" value=""/>
  <property name="apptype5" value=""/>
  <property name="heat_home" value="jre"/>
  <property name="ffmpeg_home" value=""/>

  <macrodef name="exemacro">
    <attribute name="appx"/>
    <attribute name="apptypex"/>
    <attribute name="bits"/>
    <attribute name="ico"/>
    <sequential>
      <copy file="${home}/stubs/win@{bits}@{apptypex}.exe" tofile="@{appx}.exe" overwrite="true"/>
      <java classpath="${home}/jars/javaforce.jar" classname="javaforce.utils.WinPE" fork="true">
        <arg value="@{appx}.exe"/>
        <arg value="@{ico}.ico"/>
        <arg value="@{appx}.cfg"/>
      </java>
    </sequential>
  </macrodef>

  <target name="exe" depends="jar,depjars,depnatives"  description="create msi installer file 64bit">
    <exemacro appx="${app}" apptypex="${apptype}" bits="64" ico="${ico}"/>
    <exemacro appx="${app2}" apptypex="${apptype2}" bits="64" ico="${ico2}" unless:blank="${app2}"/>
    <exemacro appx="${app3}" apptypex="${apptype3}" bits="64" ico="${ico3}" unless:blank="${app3}"/>
    <exemacro appx="${app4}" apptypex="${apptype4}" bits="64" ico="${ico4}" unless:blank="${app4}"/>
    <exemacro appx="${app5}" apptypex="${apptype5}" bits="64" ico="${ico5}" unless:blank="${app5}"/>
  </target>

  <macrodef name="msimacro">
    <attribute name="xml"/>
    <attribute name="bits"/>
    <attribute name="msi" default="${msi}"/>
    <sequential>
      <exemacro appx="${app}" apptypex="${apptype}" bits="@{bits}" ico="${ico}"/>
      <exemacro appx="${app2}" apptypex="${apptype2}" bits="@{bits}" ico="${ico2}" unless:blank="${app2}"/>
      <exemacro appx="${app3}" apptypex="${apptype3}" bits="@{bits}" ico="${ico3}" unless:blank="${app3}"/>
      <exemacro appx="${app4}" apptypex="${apptype4}" bits="@{bits}" ico="${ico4}" unless:blank="${app4}"/>
      <exemacro appx="${app5}" apptypex="${apptype5}" bits="@{bits}" ico="${ico5}" unless:blank="${app5}"/>
      <exec command="candle -ext WixFirewallExtension -ext WixUtilExtension ${candle_extra} -o wix.obj @{xml}.xml"/>
      <java classpath="${home}/jars/javaforce.jar" classname="javaforce.utils.WixHeat" fork="true">
        <arg value="${jre}"/>
        <arg value="jre.xml"/>
        <arg value="${heat_home}"/>
        <arg value="JRE"/>
      </java>
      <exec command="candle -o jre.obj jre.xml"/>
      <java classpath="${home}/jars/javaforce.jar" classname="javaforce.utils.WixHeat" fork="true">
        <arg value="${home}/ffmpeg"/>
        <arg value="ffmpeg.xml"/>
        <arg value="."/>
        <arg value="FFMPEG"/>
      </java>
      <exec command="candle -o ffmpeg.obj ffmpeg.xml"/>
      <exec command="light ${light_extra} -ext WixUIExtension -ext WixFirewallExtension -ext WixUtilExtension -cultures:en-us -b ${home} -b ${jre} -b ${home}/ffmpeg -dWixUILicenseRtf=${home}/license.rtf -o @{msi}-${version}-win@{bits}-jre.msi wix.obj jre.obj ffmpeg.obj"/>
      <delete file="wix.obj"/>
      <delete file="jre.obj"/>
      <delete file="jre.xml"/>
      <delete file="ffmpeg.obj"/>
      <delete file="ffmpeg.xml"/>
      <delete file="rt.jar"/>
      <delete file="@{msi}-${version}-win@{bits}-jre.wixpdb"/>
      <move unless:set="nomove" file="@{msi}-${version}-win@{bits}-jre.msi" todir="${home}/release"/>
    </sequential>
  </macrodef>

  <target name="msi" depends="exe,jar,depjars"  description="create msi installer file 64bit">
    <msimacro xml="wix64" bits="64"/>
  </target>

  <!-- Linux targets -->

  <macrodef name="elf">
    <attribute name="appx" default="${app}"/>
    <attribute name="apptypex" default="${apptype}"/>
    <attribute name="cfgdir" default=""/>
    <attribute name="bin" default="bin"/>
    <attribute name="bits" default="${bits}"/>
    <attribute name="ico" default=""/>
    <sequential>
      <copy file="${home}/stubs/linux@{bits}.bin" tofile="/usr/@{bin}/@{appx}"/>
      <java classpath="${home}/jars/javaforce.jar" classname="javaforce.utils.ResourceManager">
        <arg value="/usr/@{bin}/@{appx}"/>
        <arg value="@{cfgdir}@{appx}.cfg"/>
      </java>
      <chmod file="/usr/@{bin}/@{appx}" perm="+x"/>
    </sequential>
  </macrodef>

  <target name="elfall" depends="jar,depjars,depnatives" unless="noelf" description="create elf binaries">
    <elf appx="${app}" apptypex="${apptype}" ico="${ico}"/>
    <elf appx="${app2}" apptypex="${apptype2}" ico="${ico2}" unless:blank="${app2}"/>
    <elf appx="${app3}" apptypex="${apptype3}" ico="${ico3}" unless:blank="${app3}"/>
    <elf appx="${app4}" apptypex="${apptype4}" ico="${ico4}" unless:blank="${app4}"/>
    <elf appx="${app5}" apptypex="${apptype5}" ico="${ico5}" unless:blank="${app5}"/>
  </target>

  <target name="deb" depends="elfall" description="create deb package">
    <java classpath="${home}/jars/javaforce.jar" classname="javaforce.utils.GenDEB" fork="true">
      <arg value="${app}-${version}_${archext}.deb"/>
      <arg value="${arch}"/>
    </java>
    <copy file="${app}-${version}_${archext}.deb" todir="${home}/repo/debian" overwrite="true"/>
  </target>

  <target name="rpm" depends="elfall" description="create rpm package">
    <exec executable="jfrpm">
      <arg value="${app}-${version}-1.${archext}.rpm"/>
      <arg value="${arch}"/>
    </exec>
    <copy file="${app}-${version}-1.${archext}.rpm" todir="${home}/repo/fedora" overwrite="true"/>
  </target>

  <target name="pac" depends="elfall" description="create pac package">
    <exec executable="jfpac">
      <arg value="${app}-${version}-${archext}.pkg.tar.xz"/>
      <arg value="${arch}"/>
    </exec>
    <copy file="${app}-${version}-${archext}.pkg.tar.xz" todir="${home}/repo/arch/${arch}" overwrite="true"/>
  </target>

  <!-- MacOSX targets -->

  <macrodef name="mac">
    <attribute name="app" default="${app}"/>
    <sequential>
      <copy file="${home}/stubs/mac64.bin" tofile="@{app}"/>
      <chmod file="@{app}" perm="+x"/>
    </sequential>
  </macrodef>

  <target name="dmg" depends="jar"  description="create dmg package">
    <mac/>
    <java classpath="${home}/jars/javaforce.jar" classname="javaforce.utils.GenDMG" fork="true">
      <arg value="${app}"/>
      <arg value="${app}-${version}.dmg"/>
      <arg value="${jre}"/>
      <arg value="${ffmpeg_home}"/>
    </java>
    <delete file="${app}"/>
    <copy file="${app}-${version}.dmg" todir="${home}/release" overwrite="true"/>
  </target>
</project>
